---
sidebar_position: 1
---

# プログラムの流れ

GPE Solverの基本的な動作の流れを説明する。

## フローチャート
プログラムは以下のような流れで実行される。
![Flowchart](/img/flowchart.png)

### Initialization
このプロセスでは、系の外場ポテンシャルの設定やtrial wavefunctionの設定などを行う。

まず`config.txt`より設定を読み込み、allocatable variablesをメモリに割り当てる。
その後、外場ポテンシャル/trial wavefunction/位相の回転（量子渦の生成）などの設定を行い、
定常状態を解く際の計算環境を整える。

計算結果を格納するフォルダはこの時点で作成され、
フォルダ名は`data_HHmmss`というフォーマットで、実行ファイルと同じディレクトリで作成される。
また、このときに外場ポテンシャルは`potential.bin`、
trial wavefunctionは`wf_trial.bin`という名で保存される。
また、読み込んだ設定データは`config.dat`としてASCII形式でコピーされている。

:::note
外場ポテンシャルのデータはこの時に**一度だけ**生成される。
そのため、実時間発展などで後天的に変化した外場ポテンシャルの様子などは記録されない。
:::

### Solve steady state
このプロセスでは、系の虚時間発展を行って定常状態の解を求める。

まず系を時間発展させるサブルーチンである`evolve()`を呼び出し、
$\Delta \tau$だけ虚時間方向に時間発展させる。
各時刻ステップでは`energy_imag.bin`に系の状態量が記録される。

系が定常状態に収束したのかを判断するため、
その直後に収束条件と系の状態が照らし合わされる。
このとき収束条件を満たす場合、プログラムは結果の出力へと移行する。
収束しない場合は虚時刻$\tau, \tau - 1$における密度を混ぜて
さらなる虚時間発展を行う。

解の振動を抑えるためには、系のステップごとの変化を微小に抑える必要がある。
方法論としては$\Delta \tau$を小さくする方法、そして密度を混ぜる方法がある。
ここでは後者の手続きを行っており、虚時刻$\tau, \tau - 1$における密度を混ぜている。
系の状態が収束していない場合、系はさらなる虚時間発展を行う。

虚時間発展で求めた解は`wf_imag.bin`、および`wf_imag_raw.bin`に保存される。
前者はSilo Converterで読み込むための形式になっており、
後者はFortranで読み込むための形式になっている。

### Solve time development
このプロセスでは、系の実時間発展を行って各時刻ステップの系の状態を出力する。

まず系を時間発展させるサブルーチンである`evolve()`を呼び出し、
$\Delta t$だけ実時間方向に時間発展させる。
虚時間発展と異なる点は、Feedback効果や回転角速度$\Omega$を逐次的に更新しているという点である。

各時刻ステップでは`energy_real.bin`に系の状態量が記録され、
`wf_real/frame_XXX.bin`に秩序関数のデータが、
`flux_real/frame_XXX.bin`に確率流密度のデータが格納されている。

### Finalization
このプロセスでは、Initializationで割り当てたallocatable variablesをメモリから解放する。
